# archicli Live Server Integration Tests

End-to-end test suites that spawn the real CLI process against a live Archi server. Every test exercises the full `Commander parse → fetch → JSON output` pipeline — no mocking.

## Prerequisites

| Requirement | Version |
|---|---|
| **Node.js** | ≥ 18.0.0 |
| **Archi** | 5.7+ with jArchi 1.11+ |
| **Model** | Empty `.archimate` model with **at least one view open** |
| **Server** | Model API Server running on `http://127.0.0.1:8765` |

### How to reset the model

1. In Archi, create or open a blank `.archimate` model
2. Open at least one view (required for undo/redo support on the SWT thread)
3. Run **Model API Server.ajs** from the Scripts menu
4. Verify: `curl http://localhost:8765/health` returns `200`

> **Tip:** To use a different server URL, set `ARCHI_BASE_URL` (e.g. `export ARCHI_BASE_URL=http://localhost:9999`).

## Running tests

```bash
cd archicli
npm install
npm run build
```

### All suites

```bash
npm test
```

### Individual suites

| Command | Suite | Expected runtime |
|---|---|---|
| `npm run test:smoke` | Smoke tests — basic CLI commands, CRUD lifecycle | ~1 min |
| `npm run test:fixes` | FIXES.md regression — silent rollback, ghosts, duplicates | ~2 min |
| `npm run test:bulk` | Bulk stress — ~200 elements, ~300 relationships, 6 views | ~5 min |
| `npm run test:errors` | Error handling — invalid inputs, missing resources | ~30 sec |
| `npm run test:bom` | BOM composition — includes, idFiles, circular detection | ~30 sec |

Or run a single file directly:

```bash
npx vitest run __tests__/smoke.test.ts
```

## Test suites

### Smoke (`smoke.test.ts`)

Covers all CLI commands against an empty model: `health`, `model query`, `model search`, `folder list`, `ops list`, `view list`, `verify`, `batch apply`, `model element`, `view get`, `view export`, `view layout`, `view delete`, `model save`. Creates elements, relationships, and a view, then cleans up.

### FIXES.md regression (`fixes-regression.test.ts`)

Dedicated regression tests for each bug documented in FIXES.md:

| Bug | Test focus |
|---|---|
| **Bug 1 — Silent Batch Rollback** | 35 relationships in a single chunk; asserts every `tempId` resolves to a valid, retrievable `realId` |
| **Bug 2 — Ghost Objects** | Verifies `/model/diagnostics` reports zero orphans after create operations |
| **Bug 3 — Snapshot Consistency** | Create → query → delete → query; asserts counts are always accurate |
| **Bug 4 — Duplicate Detection** | Two `access-relationship`s between the same pair with different `accessType`; asserts both persist as distinct relationships |
| **Bug 5 — Large Element Batch** | 40 elements in a single batch; spot-checks random elements exist |

### Bulk modeling stress (`bulk-modeling.test.ts`)

Simulates a full agentic AI modeling workflow at scale:

1. **Phase 1** — 200 elements (`bulk-01-elements.json`)
2. **Phase 2** — 338 relationships (`bulk-02-relationships.json`, via `idFiles`)
3. **Phase 3** — 6 views with 125 visual objects + 114 connections (`bulk-03-views.json`)
4. **Phase 4** — 27 styling/note/group operations (`bulk-04-styling.json`)
5. **Phase 5** — Diagnostics: zero orphans, counts match expectations
6. **Phase 6** — Idempotent re-apply with `--skip-existing` (no new elements created)
7. **Phase 7** — `model save`

### Error handling (`error-handling.test.ts`)

Validates CLI behavior for invalid inputs: nonexistent files, schema errors, empty BOMs, missing resources (404), bad arguments, and connection-refused scenarios.

### BOM composition (`bom-composition.test.ts`)

Tests the Bill of Materials composition features: `includes` file resolution, `idFiles` for cross-session tempId mapping, circular include detection, and re-apply with `--skip-existing`.

## Fixtures

Static JSON BOMs in `__tests__/fixtures/`, generated by `generate-fixtures.mjs` for reproducibility. All valid BOMs pass `archicli verify`.

Regenerate fixtures (deterministic, safe to re-run):

```bash
node __tests__/fixtures/generate-fixtures.mjs
```

## Architecture

### Test harness (`__tests__/helpers/`)

| Module | Purpose |
|---|---|
| `cli.ts` | Spawns `npx tsx src/cli.ts <args>` with `--output json`, parses `CLIResponse<T>` envelope |
| `server.ts` | Raw `fetch()` helpers: `ensureServer()`, `assertEmptyModel()`, `getModelCounts()`, `cleanupAll()` |
| `fixtures.ts` | Path resolution, temp BOM generation, cleanup |
| `index.ts` | Re-exports all helpers |

### Execution model

- **Sequential**: Suites run one at a time (`pool: 'forks'`, `singleFork: true`)
- **Independent**: Each suite checks preconditions in `beforeAll` and cleans up in `afterAll`
- **Global order**: Smoke → Fixes → Bulk → Error → Composition (avoids model pollution, though suites are self-contained)

### Timeouts

| Setting | Value | Reason |
|---|---|---|
| `testTimeout` | 300s (5 min) | Bulk stress tests with polling |
| `hookTimeout` | 120s (2 min) | `afterAll` cleanup can cascade-delete hundreds of objects |
| CLI spawn default | 60s | Per-invocation timeout in the test harness |

## Troubleshooting

### "Server not reachable" — suite skipped

The server at `http://127.0.0.1:8765` (or `ARCHI_BASE_URL`) is not responding. Start the Model API Server script in Archi.

### "Model is not empty" — suite fails in `beforeAll`

Tests require an empty model. In Archi: close the current model, create a new blank `.archimate` file, open a view, and restart the server script.

### Rate limit errors (429)

The server defaults to 200 requests/min. Bulk tests respect this, but if you're running other clients simultaneously, you may hit limits. Stop other clients or increase the rate limit in `serverConfig.js`.

### Stale model state between runs

If a previous test run crashed without cleanup, the model may contain leftover elements. Reset by creating a fresh empty model.

### "View required for undo support"

At least one ArchiMate view must be open in Archi's editor for the undo/redo integration to work. Open any view before starting the server.

### Timeout failures on slow machines

The 5-minute timeout for bulk tests assumes reasonable hardware. If tests time out, run suites individually or increase `testTimeout` in `vitest.config.ts`.
