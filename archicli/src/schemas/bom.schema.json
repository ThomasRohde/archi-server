{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://archi-server/schemas/bom.schema.json",
  "title": "ArchiMate Bill of Materials",
  "description": "A batch of ArchiMate model change operations to apply, optionally composed from multiple files via 'includes'.",
  "type": "object",
  "required": ["version"],
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0",
      "description": "Schema version — must be '1.0'"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of what this BOM does"
    },
    "includes": {
      "type": "array",
      "description": "Relative paths to other JSON files whose 'changes' arrays are merged before applying. Resolved relative to this file's directory.",
      "items": {
        "type": "string"
      },
      "uniqueItems": true
    },
    "idFiles": {
      "type": "array",
      "description": "Relative paths to .ids.json files containing tempId→realId mappings to pre-load before applying. Enables cross-file and cross-session tempId resolution.",
      "items": {
        "type": "string"
      },
      "uniqueItems": true
    },
    "changes": {
      "type": "array",
      "description": "List of model change operations",
      "items": {
        "$ref": "#/definitions/ChangeOperation"
      }
    }
  },
  "anyOf": [
    { "required": ["changes"] },
    { "required": ["includes"] },
    { "required": ["idFiles"] }
  ],
  "definitions": {
    "ElementType": {
      "type": "string",
      "description": "Valid ArchiMate element type in kebab-case",
      "enum": [
        "resource", "capability", "value-stream", "course-of-action",
        "business-actor", "business-role", "business-collaboration",
        "business-interface", "business-process", "business-function",
        "business-interaction", "business-event", "business-service",
        "business-object", "contract", "representation", "product",
        "application-component", "application-collaboration",
        "application-interface", "application-function",
        "application-interaction", "application-process",
        "application-event", "application-service", "data-object",
        "node", "device", "system-software", "technology-collaboration",
        "technology-interface", "path", "communication-network",
        "technology-function", "technology-process", "technology-interaction",
        "technology-event", "technology-service", "artifact",
        "equipment", "facility", "distribution-network", "material",
        "stakeholder", "driver", "assessment", "goal", "outcome",
        "principle", "requirement", "constraint", "meaning", "value",
        "work-package", "deliverable", "implementation-event", "plateau", "gap",
        "location", "grouping", "junction"
      ]
    },
    "RelationshipType": {
      "type": "string",
      "description": "Valid ArchiMate relationship type",
      "enum": [
        "composition-relationship",
        "aggregation-relationship",
        "assignment-relationship",
        "realization-relationship",
        "serving-relationship",
        "access-relationship",
        "influence-relationship",
        "triggering-relationship",
        "flow-relationship",
        "specialization-relationship",
        "association-relationship"
      ]
    },
    "ChangeOperation": {
      "type": "object",
      "required": ["op"],
      "description": "A single model change operation",
      "properties": {
        "op": {
          "type": "string",
          "description": "Operation type",
          "enum": [
            "createElement",
            "createRelationship",
            "updateElement",
            "updateRelationship",
            "deleteElement",
            "deleteRelationship",
            "setProperty",
            "moveToFolder",
            "createFolder",
            "addToView",
            "addConnectionToView",
            "deleteConnectionFromView",
            "styleViewObject",
            "styleConnection",
            "moveViewObject",
            "createNote",
            "createGroup",
            "createView"
          ]
        }
      },
      "if": {
        "properties": { "op": { "const": "createElement" } }
      },
      "then": {
        "required": ["op", "type", "name"],
        "properties": {
          "type": { "$ref": "#/definitions/ElementType" },
          "name": { "type": "string" },
          "tempId": { "type": "string", "description": "Temporary ID for cross-referencing within the same batch" },
          "documentation": { "type": "string" },
          "folder": { "type": "string", "description": "Target folder path or ID" }
        }
      },
      "else": {
        "if": {
          "properties": { "op": { "const": "createRelationship" } }
        },
        "then": {
          "required": ["op", "type", "sourceId", "targetId"],
          "properties": {
            "type": { "$ref": "#/definitions/RelationshipType" },
            "sourceId": { "type": "string", "description": "Source element ID or tempId" },
            "targetId": { "type": "string", "description": "Target element ID or tempId" },
            "tempId": { "type": "string", "description": "Temporary ID for cross-referencing within the same batch" },
            "name": { "type": "string" }
          }
        },
        "else": {
          "if": {
            "properties": { "op": { "const": "createView" } }
          },
          "then": {
            "required": ["op", "name"],
            "properties": {
              "name": { "type": "string" },
              "tempId": { "type": "string", "description": "Temporary ID for cross-referencing within the same batch" },
              "documentation": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
