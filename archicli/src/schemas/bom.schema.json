{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://archi-server/schemas/bom.schema.json",
  "title": "ArchiMate Bill of Materials",
  "description": "A batch of ArchiMate model change operations to apply, optionally composed from multiple files via 'includes'.",
  "type": "object",
  "required": ["version"],
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0",
      "description": "Schema version -- must be '1.0'"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of what this BOM does"
    },
    "includes": {
      "type": "array",
      "description": "Relative paths to other JSON files whose 'changes' arrays are merged before applying. Resolved relative to this file's directory.",
      "items": {
        "type": "string"
      },
      "uniqueItems": true
    },
    "idFiles": {
      "type": "array",
      "description": "Relative paths to .ids.json files containing tempIdâ†’realId mappings to pre-load before applying. Enables cross-file and cross-session tempId resolution.",
      "items": {
        "type": "string"
      },
      "uniqueItems": true
    },
    "changes": {
      "type": "array",
      "description": "List of model change operations",
      "items": {
        "$ref": "#/definitions/ChangeOperation"
      }
    }
  },
  "anyOf": [
    { "required": ["changes"] },
    { "required": ["includes"] },
    { "required": ["idFiles"] }
  ],
  "additionalProperties": false,
  "definitions": {
    "ElementType": {
      "type": "string",
      "description": "Valid ArchiMate element type in kebab-case",
      "enum": [
        "resource", "capability", "value-stream", "course-of-action",
        "business-actor", "business-role", "business-collaboration",
        "business-interface", "business-process", "business-function",
        "business-interaction", "business-event", "business-service",
        "business-object", "contract", "representation", "product",
        "application-component", "application-collaboration",
        "application-interface", "application-function",
        "application-interaction", "application-process",
        "application-event", "application-service", "data-object",
        "node", "device", "system-software", "technology-collaboration",
        "technology-interface", "path", "communication-network",
        "technology-function", "technology-process", "technology-interaction",
        "technology-event", "technology-service", "artifact",
        "equipment", "facility", "distribution-network", "material",
        "stakeholder", "driver", "assessment", "goal", "outcome",
        "principle", "requirement", "constraint", "meaning", "value",
        "work-package", "deliverable", "implementation-event", "plateau", "gap",
        "location", "grouping", "junction"
      ]
    },
    "RelationshipType": {
      "type": "string",
      "description": "Valid ArchiMate relationship type",
      "enum": [
        "composition-relationship",
        "aggregation-relationship",
        "assignment-relationship",
        "realization-relationship",
        "serving-relationship",
        "access-relationship",
        "influence-relationship",
        "triggering-relationship",
        "flow-relationship",
        "specialization-relationship",
        "association-relationship"
      ]
    },
    "StyleProperties": {
      "type": "object",
      "description": "Common style properties for view objects and connections",
      "properties": {
        "fillColor": { "type": "string", "description": "Fill color as hex string (e.g., '#FF0000')" },
        "fontColor": { "type": "string", "description": "Font color as hex string" },
        "fontStyle": { "type": "string", "description": "Font style (e.g., 'bold', 'italic')" },
        "lineColor": { "type": "string", "description": "Line/border color as hex string" },
        "lineWidth": { "type": "integer", "description": "Line width in pixels" },
        "opacity": { "type": "integer", "description": "Opacity value (0-255)" },
        "textAlignment": { "type": "integer", "description": "Text alignment" },
        "textPosition": { "type": "integer", "description": "Text position" },
        "font": { "type": "string", "description": "Font specification" }
      }
    },
    "ChangeOperation": {
      "type": "object",
      "required": ["op"],
      "description": "A single model change operation",
      "properties": {
        "op": {
          "type": "string",
          "description": "Operation type",
          "enum": [
            "createElement",
            "createRelationship",
            "updateElement",
            "updateRelationship",
            "deleteElement",
            "deleteRelationship",
            "setProperty",
            "moveToFolder",
            "createFolder",
            "addToView",
            "addConnectionToView",
            "nestInView",
            "deleteConnectionFromView",
            "styleViewObject",
            "styleConnection",
            "moveViewObject",
            "createNote",
            "createGroup",
            "createView",
            "deleteView"
          ]
        }
      },
      "if": {
        "properties": { "op": { "const": "createElement" } }
      },
      "then": {
        "required": ["op", "type", "name"],
        "properties": {
          "op": { "type": "string" },
          "type": { "$ref": "#/definitions/ElementType" },
          "name": { "type": "string", "minLength": 1 },
          "tempId": { "type": "string", "description": "Temporary ID for cross-referencing within the same batch" },
          "documentation": { "type": "string" },
          "folder": { "type": "string", "description": "Target folder path or ID" }
        },
        "additionalProperties": false
      },
      "else": {
        "if": {
          "properties": { "op": { "const": "createRelationship" } }
        },
        "then": {
          "required": ["op", "type", "sourceId", "targetId"],
          "properties": {
            "op": { "type": "string" },
            "type": { "$ref": "#/definitions/RelationshipType" },
            "sourceId": { "type": "string", "description": "Source element ID or tempId" },
            "targetId": { "type": "string", "description": "Target element ID or tempId" },
            "tempId": { "type": "string", "description": "Temporary ID for cross-referencing within the same batch" },
            "name": { "type": "string" },
            "documentation": { "type": "string", "description": "Documentation text for the relationship" },
            "accessType": {
              "type": "integer",
              "enum": [0, 1, 2, 3],
              "description": "Access type for access-relationship: 0=write, 1=read, 2=access, 3=readwrite"
            },
            "strength": {
              "type": "string",
              "description": "Influence strength for influence-relationship (e.g., '+', '-', '++', '--', or custom)"
            }
          },
          "additionalProperties": false
        },
        "else": {
          "if": {
            "properties": { "op": { "const": "createView" } }
          },
          "then": {
            "required": ["op", "name"],
            "properties": {
              "op": { "type": "string" },
              "name": { "type": "string", "minLength": 1 },
              "tempId": { "type": "string", "description": "Temporary ID for cross-referencing within the same batch" },
              "documentation": { "type": "string" },
              "viewpoint": {
                "type": "string",
                "pattern": "^[a-z0-9_]+$",
                "description": "ArchiMate viewpoint ID (e.g., application_cooperation)"
              }
            },
            "additionalProperties": false
          },
          "else": {
            "if": {
              "properties": { "op": { "const": "createFolder" } }
            },
            "then": {
              "required": ["op", "name"],
              "properties": {
                "op": { "type": "string" },
                "name": { "type": "string", "minLength": 1 },
                "tempId": { "type": "string", "description": "Temporary ID for cross-referencing within the same batch" },
                "parentId": { "type": "string", "description": "ID of the parent folder" },
                "parentType": { "type": "string", "description": "Type of the parent folder (e.g. application, business)" }
              },
              "additionalProperties": false,
              "anyOf": [
                { "required": ["parentId"] },
                { "required": ["parentType"] }
              ]
            },
            "else": {
              "if": {
                "properties": { "op": { "const": "deleteView" } }
              },
              "then": {
                "required": ["op", "viewId"],
                "properties": {
                  "op": { "type": "string" },
                  "viewId": { "type": "string", "description": "View ID to delete" }
                },
                "additionalProperties": false
              },
              "else": {
                "if": {
                  "properties": { "op": { "const": "addToView" } }
                },
                "then": {
                  "required": ["op", "viewId", "elementId"],
                  "properties": {
                    "op": { "type": "string" },
                    "viewId": { "type": "string" },
                    "elementId": { "type": "string" },
                    "tempId": { "type": "string" },
                    "parentVisualId": { "type": "string", "description": "Parent visual object to nest inside" },
                    "x": { "type": "integer" },
                    "y": { "type": "integer" },
                    "width": { "type": "integer" },
                    "height": { "type": "integer" },
                    "autoNest": { "type": "boolean" }
                  },
                  "additionalProperties": false
                },
                "else": {
                  "if": {
                    "properties": { "op": { "const": "nestInView" } }
                  },
                  "then": {
                    "required": ["op", "viewId", "visualId", "parentVisualId"],
                    "properties": {
                      "op": { "type": "string" },
                      "viewId": { "type": "string" },
                      "visualId": { "type": "string", "description": "Visual object ID or tempId to move" },
                      "parentVisualId": { "type": "string", "description": "Target parent visual object ID or tempId" },
                      "x": { "type": "integer", "description": "X position relative to parent (default 10)" },
                      "y": { "type": "integer", "description": "Y position relative to parent (default 10)" }
                    },
                    "additionalProperties": false
                  },
                  "else": {
                    "if": {
                      "properties": { "op": { "const": "addConnectionToView" } }
                    },
                    "then": {
                      "required": ["op", "viewId", "relationshipId", "sourceVisualId", "targetVisualId"],
                      "properties": {
                        "op": { "type": "string" },
                        "viewId": { "type": "string", "description": "View ID containing the visual objects" },
                        "relationshipId": { "type": "string", "description": "Relationship ID or tempId to visualize" },
                        "sourceVisualId": { "type": "string", "description": "Source visual object ID or tempId" },
                        "targetVisualId": { "type": "string", "description": "Target visual object ID or tempId" },
                        "tempId": { "type": "string", "description": "Temporary ID for this connection visual" }
                      },
                      "additionalProperties": false
                    },
                    "else": {
                      "if": {
                        "properties": { "op": { "const": "updateElement" } }
                      },
                      "then": {
                        "required": ["op", "id"],
                        "anyOf": [
                          { "required": ["name"] },
                          { "required": ["documentation"] },
                          { "required": ["properties"] }
                        ],
                        "properties": {
                          "op": { "type": "string" },
                          "id": { "type": "string", "description": "Element ID or tempId to update" },
                          "name": { "type": "string" },
                          "documentation": { "type": "string" },
                          "properties": {
                            "type": "object",
                            "description": "Key-value properties to set",
                            "additionalProperties": { "type": "string" }
                          }
                        },
                        "additionalProperties": false
                      },
                      "else": {
                        "if": {
                          "properties": { "op": { "const": "updateRelationship" } }
                        },
                        "then": {
                          "required": ["op", "id"],
                          "anyOf": [
                            { "required": ["name"] },
                            { "required": ["documentation"] },
                            { "required": ["properties"] }
                          ],
                          "properties": {
                            "op": { "type": "string" },
                            "id": { "type": "string", "description": "Relationship ID or tempId to update" },
                            "name": { "type": "string" },
                            "documentation": { "type": "string" },
                            "properties": {
                              "type": "object",
                              "description": "Key-value properties to set",
                              "additionalProperties": { "type": "string" }
                            }
                          },
                          "additionalProperties": false
                        },
                        "else": {
                          "if": {
                            "properties": { "op": { "const": "deleteElement" } }
                          },
                          "then": {
                            "required": ["op", "id"],
                            "properties": {
                              "op": { "type": "string" },
                              "id": { "type": "string", "description": "Element ID or tempId to delete" },
                              "cascade": { "type": "boolean", "description": "Whether to cascade delete relationships (default true)" }
                            },
                            "additionalProperties": false
                          },
                          "else": {
                            "if": {
                              "properties": { "op": { "const": "deleteRelationship" } }
                            },
                            "then": {
                              "required": ["op", "id"],
                              "properties": {
                                "op": { "type": "string" },
                                "id": { "type": "string", "description": "Relationship ID or tempId to delete" }
                              },
                              "additionalProperties": false
                            },
                            "else": {
                              "if": {
                                "properties": { "op": { "const": "setProperty" } }
                              },
                              "then": {
                                "required": ["op", "id", "key", "value"],
                                "properties": {
                                  "op": { "type": "string" },
                                  "id": { "type": "string", "description": "Element or relationship ID or tempId" },
                                  "key": { "type": "string", "minLength": 1, "description": "Property key" },
                                  "value": { "type": "string", "description": "Property value" }
                                },
                                "additionalProperties": false
                              },
                              "else": {
                                "if": {
                                  "properties": { "op": { "const": "moveToFolder" } }
                                },
                                "then": {
                                  "required": ["op", "id", "folderId"],
                                  "properties": {
                                    "op": { "type": "string" },
                                    "id": { "type": "string", "description": "Element or relationship ID or tempId to move" },
                                    "folderId": { "type": "string", "description": "Target folder ID or tempId" }
                                  },
                                  "additionalProperties": false
                                },
                                "else": {
                                  "if": {
                                    "properties": { "op": { "const": "deleteConnectionFromView" } }
                                  },
                                  "then": {
                                    "required": ["op", "viewId", "connectionId"],
                                    "properties": {
                                      "op": { "type": "string" },
                                      "viewId": { "type": "string", "description": "View ID containing the connection" },
                                      "connectionId": { "type": "string", "description": "Visual connection ID or tempId to remove" }
                                    },
                                    "additionalProperties": false
                                  },
                                  "else": {
                                    "if": {
                                      "properties": { "op": { "const": "styleViewObject" } }
                                    },
                                    "then": {
                                      "required": ["op", "viewObjectId"],
                                      "properties": {
                                        "op": { "type": "string" },
                                        "viewObjectId": { "type": "string", "description": "Visual object ID or tempId to style" },
                                        "fillColor": { "type": "string" },
                                        "fontColor": { "type": "string" },
                                        "fontStyle": { "type": "string" },
                                        "lineColor": { "type": "string" },
                                        "lineWidth": { "type": "integer" },
                                        "opacity": { "type": "integer" },
                                        "textAlignment": { "type": "integer" },
                                        "textPosition": { "type": "integer" },
                                        "font": { "type": "string" }
                                      },
                                      "additionalProperties": false
                                    },
                                    "else": {
                                      "if": {
                                        "properties": { "op": { "const": "styleConnection" } }
                                      },
                                      "then": {
                                        "required": ["op", "connectionId"],
                                        "properties": {
                                          "op": { "type": "string" },
                                          "connectionId": { "type": "string", "description": "Visual connection ID or tempId to style" },
                                          "lineColor": { "type": "string" },
                                          "lineWidth": { "type": "integer" },
                                          "font": { "type": "string" },
                                          "fontColor": { "type": "string" },
                                          "fontStyle": { "type": "string" },
                                          "textPosition": { "type": "integer" }
                                        },
                                        "additionalProperties": false
                                      },
                                      "else": {
                                        "if": {
                                          "properties": { "op": { "const": "moveViewObject" } }
                                        },
                                        "then": {
                                          "required": ["op", "viewObjectId"],
                                          "anyOf": [
                                            { "required": ["x"] },
                                            { "required": ["y"] },
                                            { "required": ["width"] },
                                            { "required": ["height"] }
                                          ],
                                          "properties": {
                                            "op": { "type": "string" },
                                            "viewObjectId": { "type": "string", "description": "Visual object ID or tempId to move/resize" },
                                            "x": { "type": "integer", "description": "New X position" },
                                            "y": { "type": "integer", "description": "New Y position" },
                                            "width": { "type": "integer", "description": "New width" },
                                            "height": { "type": "integer", "description": "New height" }
                                          },
                                          "additionalProperties": false
                                        },
                                        "else": {
                                          "if": {
                                            "properties": { "op": { "const": "createNote" } }
                                          },
                                          "then": {
                                            "required": ["op", "viewId", "content"],
                                            "properties": {
                                              "op": { "type": "string" },
                                              "viewId": { "type": "string", "description": "View ID to add the note to" },
                                              "content": { "type": "string", "minLength": 1, "description": "Note text content" },
                                              "tempId": { "type": "string", "description": "Temporary ID for cross-referencing" },
                                              "x": { "type": "integer" },
                                              "y": { "type": "integer" },
                                              "width": { "type": "integer" },
                                              "height": { "type": "integer" }
                                            },
                                            "additionalProperties": false
                                          },
                                          "else": {
                                            "if": {
                                              "properties": { "op": { "const": "createGroup" } }
                                            },
                                            "then": {
                                              "required": ["op", "viewId", "name"],
                                              "properties": {
                                                "op": { "type": "string" },
                                                "viewId": { "type": "string", "description": "View ID to add the group to" },
                                                "name": { "type": "string", "minLength": 1, "description": "Group label" },
                                                "tempId": { "type": "string", "description": "Temporary ID for cross-referencing" },
                                                "documentation": { "type": "string" },
                                                "x": { "type": "integer" },
                                                "y": { "type": "integer" },
                                                "width": { "type": "integer" },
                                                "height": { "type": "integer" }
                                              },
                                              "additionalProperties": false
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
